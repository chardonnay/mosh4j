name: Daily Snapshot Build

on:
  schedule:
    # TÃ¤glich um 03:15 UTC
    - cron: "15 3 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  detect-new-main-commit:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.detect.outputs.should_build }}
      previous_success_sha: ${{ steps.detect.outputs.previous_success_sha }}
    steps:
      - name: Detect whether main changed since last successful snapshot
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflowId = "daily-snapshot.yml";
            const branch = "main";

            const runs = await github.paginate(github.rest.actions.listWorkflowRuns, {
              owner,
              repo,
              workflow_id: workflowId,
              branch,
              status: "completed",
              per_page: 100
            });

            const successfulRuns = runs
              .filter((r) => r.conclusion === "success" && r.id !== context.runId)
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const lastSuccessfulRun = successfulRuns[0];
            const previousSuccessSha = lastSuccessfulRun ? lastSuccessfulRun.head_sha : "";
            const shouldBuild = !previousSuccessSha || previousSuccessSha !== context.sha;

            core.setOutput("previous_success_sha", previousSuccessSha);
            core.setOutput("should_build", String(shouldBuild));

            core.info(`Current main SHA: ${context.sha}`);
            core.info(`Previous successful snapshot SHA: ${previousSuccessSha || "none"}`);
            core.info(`Should build: ${shouldBuild}`);

  build-snapshot:
    needs: detect-new-main-commit
    if: needs.detect-new-main-commit.outputs.should_build == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package

      - name: Collect snapshot JARs
        run: |
          mkdir -p snapshot-jars
          while IFS= read -r jar; do
            base_name="$(basename "$jar" .jar)"
            cp "$jar" "snapshot-jars/${base_name}-${{ matrix.arch }}.jar"
          done < <(find . -path "*/target/*.jar" \
            ! -name "*-sources*.jar" \
            ! -name "*-javadoc*.jar" \
            ! -name "*-tests*.jar" \
            ! -name "original-*.jar")

      - name: Upload snapshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-${{ github.sha }}-${{ matrix.arch }}
          path: snapshot-jars/*.jar
          retention-days: 14

  skip-note:
    needs: detect-new-main-commit
    if: needs.detect-new-main-commit.outputs.should_build != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: No new commits on main
        run: |
          echo "No new commit on main since last successful snapshot."
          echo "Previous successful snapshot SHA: ${{ needs.detect-new-main-commit.outputs.previous_success_sha }}"
